<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Machine Wise CT Graph</title>

    <link rel="icon" type="image/png" href="/images/favicon-d.png" />

    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1/dist/chartjs-plugin-zoom.min.js"></script>

    <style>
      :root {
        --bg: #eef1f5;
        --card: #ffffff;
        --primary: #0b5ed7;
        --danger: #c62828;
        --text: #1f2937;
        --muted: #6b7280;
        --border: #d1d5db;
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        font-family: "Segoe UI", Arial, sans-serif;
        background: var(--bg);
        color: var(--text);
      }

      /* ===== TOP BAR ===== */
      .topbar {
        background: #fff;
        padding: 14px 18px;
        border-bottom: 2px solid var(--border);
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .topbar h2 {
        margin: 0;
        font-size: 20px;
        font-weight: 600;
      }

      /* ===== CONTROLS ===== */
      .controls {
        display: flex;
        gap: 10px;
        align-items: center;
      }

      input[type="date"],
      input[type="number"] {
        padding: 6px 8px;
        border: 1px solid var(--border);
        border-radius: 4px;
        font-size: 14px;
      }

      .btn {
        padding: 7px 14px;
        border: none;
        border-radius: 4px;
        font-weight: 600;
        cursor: pointer;
        font-size: 14px;
      }

      .btn-primary {
        background: var(--primary);
        color: #fff;
      }
      .btn-primary:hover {
        background: #084298;
      }

      .btn-outline {
        background: #fff;
        border: 1px solid var(--primary);
        color: var(--primary);
      }
      .btn-outline:hover {
        background: #e7f1ff;
      }

      /* ===== PAGE ===== */
      .page {
        padding: 16px;
      }

      /* ===== MACHINE CARD ===== */
      .machine-card {
        background: var(--card);
        border-radius: 8px;
        margin-bottom: 18px;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
        border-left: 6px solid var(--primary);
      }

      .machine-header {
        padding: 10px 14px;
        font-weight: 600;
        font-size: 16px;
        border-bottom: 1px solid var(--border);
      }

      .chart-wrap {
        height: 320px;
        padding: 10px;
      }

      canvas {
        width: 100% !important;
        height: 100% !important;
        cursor: pointer;
      }

      /* ===== VIDEO MODAL ===== */
      .modal {
        display: none;
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.8);
        justify-content: center;
        align-items: center;
        z-index: 9999;
      }

      .modal-content {
        width: 90%;
        max-width: 1000px;
        background: #000;
        padding: 10px;
        border-radius: 8px;
        position: relative;
      }

      .modal video {
        width: 100%;
        border-radius: 6px;
      }

      .close-btn {
        position: absolute;
        top: -12px;
        right: -12px;
        width: 34px;
        height: 34px;
        border-radius: 50%;
        border: none;
        background: var(--danger);
        color: #fff;
        font-size: 18px;
        cursor: pointer;
        font-weight: bold;
      }
    </style>
  </head>

  <body>
    <!-- ===== TOP BAR ===== -->
    <div class="topbar">
      <h2>ðŸ“Š Machine Wise CT Monitoring</h2>
      <div class="controls">
        <label>Date:</label>
        <input type="date" id="datePicker" />
        <label>Y-Max:</label>
        <input type="number" id="yMaxInput" value="100" style="width: 80px" />
        <button class="btn btn-outline" onclick="applyYMax()">Apply</button>
        <button class="btn btn-primary" onclick="loadData()">Load</button>
      </div>
    </div>

    <div class="page">
      <div id="graphs"></div>
    </div>

    <!-- ===== VIDEO POPUP ===== -->
    <div class="modal" id="videoModal" onclick="closePopup()">
      <div class="modal-content" onclick="event.stopPropagation()">
        <button class="close-btn" onclick="closePopup()">âœ–</button>
        <video id="popupVideo" controls autoplay muted></video>
      </div>
    </div>

    <script>
      /* ===== MACHINE â†’ CAMERA ===== */
      const machineCameraMap = {
        "C. Pulley Tightening": "cam2",
        "D. Stator P/F": "cam4",
        "E. RRF P/F": "cam3",
        "L. P-terminal": "cam1",
      };

      function getCameraByMachine(machine) {
        return machineCameraMap[machine] || "cam1";
      }

      let charts = {};
      let currentYMax = 100;

      datePicker.value = new Date().toISOString().split("T")[0];

      /* ===== LOAD DATA ===== */
      async function loadData() {
        const res = await fetch(`/graphdatax?date=${datePicker.value}`);
        const json = await res.json();

        graphs.innerHTML = "";
        charts = {};

        json.machines.sort().forEach((machine) => {
          const records = json.dataByMachine[machine];
          if (!records || records.length < 2) return;

          const card = document.createElement("div");
          card.className = "machine-card";
          card.innerHTML = `
      <div class="machine-header">${machine}</div>
      <div class="chart-wrap"><canvas></canvas></div>
    `;
          graphs.appendChild(card);

          const canvas = card.querySelector("canvas");
          const labels = records.map((r) => new Date(r.timestamp));

          charts[machine] = new Chart(canvas, {
            type: "line",
            data: {
              labels,
              datasets: [
                {
                  label: "ACTUAL CT",
                  data: records.map((r) => r.second),
                  borderColor: "#c62828",
                  backgroundColor: "rgba(198,40,40,.2)",
                  fill: true,
                  tension: 0.4,
                  pointRadius: 2,
                  pointHoverRadius: 6,
                },
                {
                  label: "PLAN CT",
                  data: records.map((r) => r.second2),
                  borderColor: "#0b5ed7",
                  borderDash: [6, 4],
                  tension: 0.3,
                  pointRadius: 0,
                },
              ],
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              onClick: (evt, el) => {
                if (!el.length) return;
                const ts = labels[el[0].index];
                openRecorded(ts, getCameraByMachine(machine));
              },
              scales: {
                x: { type: "time", time: { unit: "minute" } },
                y: { beginAtZero: true, max: currentYMax },
              },
              plugins: {
                zoom: {
                  zoom: { wheel: { enabled: true }, mode: "x" },
                  pan: { enabled: true, mode: "y" },
                },
              },
            },
          });
        });
      }

      function applyYMax() {
        currentYMax = Number(yMaxInput.value) || 100;
        Object.values(charts).forEach((c) => {
          c.options.scales.y.max = currentYMax;
          c.update();
        });
      }

      /* ===== VIDEO ===== */
      function openRecorded(ts, cameraId) {
        popupVideo.pause();
        popupVideo.src = `/api/camera/video?cameraId=${cameraId}&ts=${ts.toISOString()}`;
        videoModal.style.display = "flex";
      }

      function closePopup() {
        popupVideo.pause();
        popupVideo.src = "";
        videoModal.style.display = "none";
      }

      document.addEventListener("keydown", (e) => {
        if (e.key === "Escape") closePopup();
      });

      /* INIT */
      loadData();
      setInterval(loadData, 30000);
    </script>
  </body>
</html>

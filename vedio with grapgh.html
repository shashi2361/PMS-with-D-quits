<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>CT Graph with Video Popup</title>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
<script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>

<style>
  body{
    font-family:Arial;
    background:#f4f6f8;
    margin:0;
    padding:0;
  }

  .page{
    max-width:1200px;
    margin:auto;
    padding:12px;
  }

  .header{
    display:flex;
    justify-content:space-between;
    align-items:center;
    margin-bottom:10px;
  }

  h3{margin:0}

  .live-btn{
    background:#d32f2f;
    color:#fff;
    border:none;
    padding:8px 16px;
    cursor:pointer;
    border-radius:4px;
    font-weight:bold;
  }

  .card{
    background:#fff;
    border-radius:6px;
    padding:10px;
    box-shadow:0 1px 4px rgba(0,0,0,0.1);
  }

  canvas{
    width:100% !important;
    height:300px !important;
  }

  /* ===== POPUP ===== */
  .modal{
    display:none;
    position:fixed;
    inset:0;
    background:rgba(0,0,0,0.75);
    z-index:9999;
    justify-content:center;
    align-items:center;
  }

  .modal-content{
    width:90%;
    max-width:1000px;
    background:#000;
    padding:10px;
    border-radius:6px;
    position:relative;
  }

  .modal video{
    width:100%;
    background:#000;
  }

  .close-btn{
    position:absolute;
    top:-12px;
    right:-12px;
    width:32px;
    height:32px;
    border:none;
    border-radius:50%;
    font-size:18px;
    cursor:pointer;
  }
</style>
</head>

<body>

<div class="page">

  <div class="header">
    <h3>CT Line Graph</h3>
    <button class="live-btn" onclick="openLivePopup()">ðŸ”´ LIVE CAMERA</button>
  </div>

  <div class="card">
    <canvas id="lineChart"></canvas>
  </div>

</div>

<!-- ===== COMMON POPUP (LIVE + RECORDED) ===== -->
<div class="modal" id="videoModal">
  <div class="modal-content">
    <button class="close-btn" onclick="closePopup()">âœ–</button>
    <video id="popupVideo" controls autoplay muted></video>
  </div>
</div>

<script>
/* ================= GRAPH HELPERS ================= */
function isExcluded(date){
  const h=date.getHours().toString().padStart(2,'0');
  const m=date.getMinutes().toString().padStart(2,'0');
  const hm=`${h}:${m}`;
  const ranges=[
    ["07:30","07:40"],["11:00","11:30"],["12:30","12:40"],
    ["15:30","15:40"],["19:00","19:30"],["20:30","20:40"],
    ["23:00","23:10"],["02:00","02:30"],["04:30","04:40"]
  ];
  return ranges.some(([s,e])=>hm>=s && hm<=e);
}

/* ================= GRAPH ================= */
let lineChart;

async function fetchLineChart(){
  const res = await fetch('/graphdata');
  const data = await res.json();
  if(!data || data.length < 2) return;

  const filtered = data.filter(d=>!isExcluded(new Date(d.timestamp)));
  const labels = filtered.map(d=>new Date(d.timestamp));
  const actual = filtered.map(d=>d.second);
  const plan   = filtered.map(d=>d.second2);

  if(lineChart) lineChart.destroy();

  lineChart = new Chart(document.getElementById("lineChart"),{
    type:'line',
    data:{
      labels,
      datasets:[
        {label:'ACTUALCT',data:actual,borderColor:'red',pointRadius:2,tension:0.8},
        {label:'PLANCT',data:plan,borderColor:'blue',pointRadius:0,tension:0.3}
      ]
    },
    options:{
      responsive:true,
      maintainAspectRatio:false,

      onClick:(evt,elements)=>{
        if(!elements.length) return;
        const clickedTime = labels[elements[0].index];
        openRecordedPopup(clickedTime);
      },

      scales:{
        x:{type:'time',time:{unit:'hour',displayFormats:{hour:'HH:mm'}}},
        y:{beginAtZero:true,max:100}
      },
      plugins:{legend:{position:'bottom'}}
    }
  });
}

fetchLineChart();
setInterval(fetchLineChart,60000);

/* ================= POPUP VIDEO ================= */
let hls = null;

function resetVideo(video){
  video.pause();
  video.currentTime = 0;
  if(hls){ hls.destroy(); hls=null; }
}

/* GRAPH CLICK â†’ RECORDED VIDEO (POPUP) */
function openRecordedPopup(dateObj){
  const modal = document.getElementById("videoModal");
  const video = document.getElementById("popupVideo");

  modal.style.display="flex";
  resetVideo(video);

  const ts = dateObj.toISOString();   // âœ… SAME AS YOUR WORKING VERSION
  video.src = `/api/camera/video?ts=${ts}`;

  video.onloadedmetadata = () => {
    video.play().catch(()=>{});
  };

  video.onerror = () => {
    alert("âš  Video not found for this time");
  };
}

/* LIVE BUTTON â†’ LIVE VIDEO (POPUP) */
function openLivePopup(){
  const modal = document.getElementById("videoModal");
  const video = document.getElementById("popupVideo");

  modal.style.display="flex";
  resetVideo(video);

  const src="/hls/live.m3u8";
  if(Hls.isSupported()){
    hls = new Hls();
    hls.loadSource(src);
    hls.attachMedia(video);
  }else{
    video.src = src;
  }
}

function closePopup(){
  document.getElementById("videoModal").style.display="none";
  resetVideo(document.getElementById("popupVideo"));
}
</script>

</body>
</html>
